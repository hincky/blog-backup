(window.webpackJsonp=window.webpackJsonp||[]).push([[56],{375:function(t,s,a){"use strict";a.r(s);var e=a(14),n=Object(e.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"rke-install-kubernetes"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#rke-install-kubernetes"}},[t._v("#")]),t._v(" rke install kubernetes")]),t._v(" "),s("p",[t._v("没有特殊标明，就是所有主机都要进行操作")]),t._v(" "),s("h2",{attrs:{id:"前期准备"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#前期准备"}},[t._v("#")]),t._v(" 前期准备")]),t._v(" "),s("p",[t._v("centos\ndocker-ce 20.10.12\nk8s v1.22.5")]),t._v(" "),s("p",[t._v("m1    controlplane,rancher,rke\nn1    worker\nn2    worker\netcd1 etcd")]),t._v(" "),s("p",[t._v("hostnamectl set-hostname master")]),t._v(" "),s("p",[t._v("cat >> /etc/hosts << EOF\n127.0.0.1   $(hostname)\n10.0.20.6   master\n10.0.8.13   node2\n10.0.8.12   node1\n43.138.161.91   master\n43.138.197.127   node2\n43.138.215.165   node1\nEOF")]),t._v(" "),s("p",[t._v("mv /etc/yum.repos.d/CentOS-Base.repo /etc/yum.repos.d/CentOS-Base.repo.backup")]),t._v(" "),s("p",[t._v("wget -O /etc/yum.repos.d/CentOS-Base.repo https://mirrors.aliyun.com/repo/Centos-vault-8.5.2111.repo")]),t._v(" "),s("p",[t._v("yum makecache")]),t._v(" "),s("p",[t._v("mv /etc/yum.repos.d/CentOS-Stream-BaseOS.repo /etc/yum.repos.d/CentOS-Stream-BaseOS.repo.backup")]),t._v(" "),s("p",[t._v("wget -O /etc/yum.repos.d/CentOS-Stream-BaseOS.repo https://mirrors.aliyun.com/repo/Centos-vault-8.5.2111.repo")]),t._v(" "),s("p",[t._v("yum makecache")]),t._v(" "),s("h4",{attrs:{id:"手动修改"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#手动修改"}},[t._v("#")]),t._v(" 手动修改")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("vim")]),t._v(" /etc/sysctl.conf\n\nnet.ipv4.ip_forward "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\nnet.bridge.bridge-nf-call-ip6tables "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\nnet.bridge.bridge-nf-call-iptables "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v("\n")])])]),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("modprobe br_netfilter\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sysctl")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" /etc/sysctl.conf\n")])])]),s("h4",{attrs:{id:"代码自动修改"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#代码自动修改"}},[t._v("#")]),t._v(" 代码自动修改")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sed")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-ri")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'s/net.ipv4.ip_forward.*/net.ipv4.ip_forward = 1/'")]),t._v(" /etc/sysctl.conf\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sed")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-ri")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'s/net.bridge.bridge-nf-call-ip6tables.*/net.bridge.bridge-nf-call-ip6tables = 1/'")]),t._v(" /etc/sysctl.conf\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sed")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-ri")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'s/net.bridge.bridge-nf-call-iptables.*/net.bridge.bridge-nf-call-iptables = 1/'")]),t._v(" /etc/sysctl.conf\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" /etc/sysctl.conf\nmodprobe br_netfilter\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sysctl")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" /etc/sysctl.conf\n")])])]),s("h3",{attrs:{id:"关闭防火墙和selinux"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#关闭防火墙和selinux"}},[t._v("#")]),t._v(" 关闭防火墙和selinux")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("systemctl disable firewalld "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" systemctl stop firewalld\n\nfirewall-cmd "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--state")]),t._v("\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sed")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-ri")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'s/SELINUX=enforcing/SELINUX=disabled/'")]),t._v(" /etc/selinux/config\n")])])]),s("h4",{attrs:{id:"sed用法"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#sed用法"}},[t._v("#")]),t._v(" sed用法")]),t._v(" "),s("p",[t._v("sed -ri 's/text=before/text=after/'  file")]),t._v(" "),s("p",[t._v("s表示替换，将后面的替换到前面")]),t._v(" "),s("h3",{attrs:{id:"关闭swap"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#关闭swap"}},[t._v("#")]),t._v(" 关闭swap")]),t._v(" "),s("p",[t._v("sed -ri 's/."),s("em",[t._v("swap.")]),t._v("/#&/' /etc/fstab")]),t._v(" "),s("h3",{attrs:{id:"时间同步"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#时间同步"}},[t._v("#")]),t._v(" 时间同步")]),t._v(" "),s("p",[t._v("yum install -y ntpdate")]),t._v(" "),s("p",[t._v("crontab -e\n0 "),s("em",[t._v("/1")]),t._v("** ntpdate time1.aliyun.com")]),t._v(" "),s("h2",{attrs:{id:"install-docker"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#install-docker"}},[t._v("#")]),t._v(" install docker")]),t._v(" "),s("h3",{attrs:{id:"配置docker-yum源"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置docker-yum源"}},[t._v("#")]),t._v(" 配置docker yum源")]),t._v(" "),s("p",[t._v("wget -O /etc/yum.repos.d/docker-ce.repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo")]),t._v(" "),s("h3",{attrs:{id:"install-docker-2"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#install-docker-2"}},[t._v("#")]),t._v(" install docker")]),t._v(" "),s("p",[t._v("yum -y install docker-ce")]),t._v(" "),s("p",[t._v("systemctl enable docker && systemctl start docker")]),t._v(" "),s("h3",{attrs:{id:"配置docker容器镜像加速器"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#配置docker容器镜像加速器"}},[t._v("#")]),t._v(" 配置docker容器镜像加速器")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" /etc/docker\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tee")]),t._v(" /etc/docker/daemon.json "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<-")]),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'EOF\'\n{\n  "registry-mirrors": ["https://mvl6n9ol.mirror.aliyuncs.com"]\n}\nEOF')]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" systemctl daemon-reload\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("sudo")]),t._v(" systemctl restart "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v("\n")])])]),s("h2",{attrs:{id:"install-docker-compose"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#install-docker-compose"}},[t._v("#")]),t._v(" install docker compose")]),t._v(" "),s("p",[t._v('sudo curl -L "https://github.com/docker/compose/releases/download/1.28.5/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose')]),t._v(" "),s("p",[t._v("chmod +x /usr/local/bin/docker-compose")]),t._v(" "),s("p",[t._v("docker-compose --version")]),t._v(" "),s("h2",{attrs:{id:"add-rancher-user"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#add-rancher-user"}},[t._v("#")]),t._v(" add rancher user")]),t._v(" "),s("p",[t._v("使用centos的rke，不能用root，所以添加专门的账号进行docker操作")]),t._v(" "),s("p",[t._v("useradd rke")]),t._v(" "),s("p",[t._v("usermod -aG docker rke")]),t._v(" "),s("p",[t._v("cat /etc/group | grep docker")]),t._v(" "),s("p",[t._v("echo zxcvbnm | passwd --stdin rke")]),t._v(" "),s("h2",{attrs:{id:"生成ssh证书用于部署集群"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#生成ssh证书用于部署集群"}},[t._v("#")]),t._v(" 生成ssh证书用于部署集群")]),t._v(" "),s("p",[t._v("rke部署过程要用rke用户登录到每台主机进行操作")]),t._v(" "),s("p",[t._v("root生成就行\nssh-keygen")]),t._v(" "),s("p",[t._v("ssh-copy-id rke@master\nssh-copy-id rke@node1\nssh-copy-id rke@node2")]),t._v(" "),s("h3",{attrs:{id:"验证ssh证书是否可用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#验证ssh证书是否可用"}},[t._v("#")]),t._v(" 验证ssh证书是否可用")]),t._v(" "),s("p",[t._v("ssh rke@master\ndocker ps\nexit")]),t._v(" "),s("p",[t._v("ssh rke@node1\ndocker ps\nexit")]),t._v(" "),s("p",[t._v("ssh rke@node2\ndocker ps\nexit")]),t._v(" "),s("h2",{attrs:{id:"install-rke"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#install-rke"}},[t._v("#")]),t._v(" install rke")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://github.com/rancher/rke/releases/download/v1.3.15/rke_linux-amd64 "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mv")]),t._v(" rke_linux-amd64 rke\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("chmod")]),t._v(" +x rke "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" rke "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--version")]),t._v("\n")])])]),s("p",[t._v("下表是这个rke版本支持k8s版本，如果要装其他版本的rke，"),s("a",{attrs:{href:"https://github.com/rancher/rke/releases",target:"_blank",rel:"noopener noreferrer"}},[t._v("参考github官网"),s("OutboundLink")],1)]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",{staticStyle:{"text-align":"center"}},[t._v("Kubernetes support")])])]),t._v(" "),s("tbody",[s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("v1.24.4-rancher1-1 (Default)")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("v1.23.10-rancher1-1")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("v1.22.13-rancher1-1")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("v1.21.14-rancher1-1")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("v1.20.15-rancher2-2")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("v1.19.16-rancher2-1")])]),t._v(" "),s("tr",[s("td",{staticStyle:{"text-align":"center"}},[t._v("v1.18.20-rancher1-3")])])])]),t._v(" "),s("p",[t._v("下面安装k8s版本，我选了"),s("code",[t._v("v1.21.14-rancher1")])]),t._v(" "),s("h2",{attrs:{id:"init-rke-config-yaml"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#init-rke-config-yaml"}},[t._v("#")]),t._v(" init rke config.yaml")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" /app/rancher\n\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" /app/rancher\n\nrke config "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--name")]),t._v(" cluster.yaml\n")])])]),s("div",{staticClass:"language- extra-class"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[t._v('ssh key path: \nnumber of hosts:3\naddress of host1:10.0.20.6\nport:\nssh private key of host : ~/.ssh/id_rsa\nuser:rke\ncontrol:y\nworker:n\netcd:n\nhostname:master\ninternal ip:\ndocker socket path:\n\nssh address of host:10.0.8.12\nport:\nssh private key of host : ~/.ssh/id_rsa\nuser:rke\ncontrol:n\nworker:y\netcd:n\nhostname:node1\ninternal ip:\ndocker socket path:\n\nssh address of host:10.0.8.13\nport:\nssh private key of host : ~/.ssh/id_rsa\nuser:rke\ncontrol:n\nworker:n\netcd:y\nhostname:node2\ninternal ip:\ndocker socket path:\n...\nkubernetes docker image [这个默认是最新的实验版本，一定要改成稳定版本]:rancher/hyperkube:v1.22.5-rancher1\n\nrancher/hyperkube:v1.21.14-rancher1\ncluster domain: kube.hincky.com\n...\n\n\n如果要部署kubeflow或istio就一定要再kube-controller:配置下面参数\ncluster-signing-cert-file: "/etc/kubernetes/ssl/kube-ca.pem"\ncluster-signing-key-file: "/etc/kubernetes/ssl/kube-ca-key.pem"\n')])])]),s("h2",{attrs:{id:"集群部署"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#集群部署"}},[t._v("#")]),t._v(" 集群部署")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("su")]),t._v(" rke \n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v("\n\nrke up "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 默认就是--config cluster.yaml")]),t._v("\n")])])]),s("p",[t._v("期间出现错误的话，重新rke up就好了。。。")]),t._v(" "),s("h2",{attrs:{id:"install-kubectl"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#install-kubectl"}},[t._v("#")]),t._v(" install kubectl")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cat")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /etc/yum.repos.d/kubernetes.repo "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<<")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("END\n[kubernetes]\nname = kubernetes\nbaseurl = https://mirrors.aliyun.com/kubernetes/yum/repos/kubernetes-el7-x86_64/\ngpgchek = 1\ngpgkey = https://mirrors.aliyun.com/kubernetes/yum/doc/rpm-package-key.gpg\n         https://mirrors.aliyun.com/kubernetes/yum/doc/yum-key.gpg\nenable = 1\nEND")]),t._v("\n\nyum "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-y")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v(" kubectl-1.21.14\n\nkubectl version "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--client")]),t._v("\n")])])]),s("h3",{attrs:{id:"让kubectl-访问到集群"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#让kubectl-访问到集群"}},[t._v("#")]),t._v(" 让kubectl 访问到集群")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("ls")]),t._v(" /app/rancher\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("mkdir")]),t._v(" ~/.kube\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("cp")]),t._v(" /app/rancher/kube_config_cluster.yml /root/.kube/config "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 如果是卸载重装，这一步要用y确认")]),t._v("\n\nkubectl get nodes\n\nkubectl get po "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-A")]),t._v("\n")])])]),s("h2",{attrs:{id:"部署rancher管理k8s集群"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#部署rancher管理k8s集群"}},[t._v("#")]),t._v(" 部署rancher管理k8s集群")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" run "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-d")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--restart")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v("unless-stopped "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--privileged")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--name")]),t._v(" rancher "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v(":80 "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-p")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v(":443 rancher/rancher:v2.5.13\n\n")])])]),s("p",[t._v("然后根据ip访问你的rancher即可")]),t._v(" "),s("h3",{attrs:{id:"将本地集群添加到rancher"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#将本地集群添加到rancher"}},[t._v("#")]),t._v(" 将本地集群添加到rancher")]),t._v(" "),s("p",[t._v("先切换rancher界面的语言为中文，右下角切换")]),t._v(" "),s("p",[t._v("rancher界面-添加集群-导入-定义集群名称-保存")]),t._v(" "),s("p",[t._v("如果没有配置ssl证书，就拷贝最下面的命令到kubectl节点上执行")]),t._v(" "),s("p",[t._v("curl --insecure -sfL https://kube.hincky.com/v3/import/svvjpznpxgl49h9wq5hbc9vtwbpcbn9l75s6twpkswslqh9sq42vt9_c-4lq9p.yaml | kubectl apply -f -")]),t._v(" "),s("p",[t._v("等待一会儿再看rancher即可")]),t._v(" "),s("h2",{attrs:{id:"集群节点更新"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#集群节点更新"}},[t._v("#")]),t._v(" 集群节点更新")]),t._v(" "),s("blockquote",[s("p",[t._v("注意")])]),t._v(" "),s("p",[t._v("主机在添加到集群之前，环境准备要与已在集群的主机环境一致，所以上面除rke的步骤之外，都要重复一遍")]),t._v(" "),s("h3",{attrs:{id:"添加worker节点"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#添加worker节点"}},[t._v("#")]),t._v(" 添加worker节点")]),t._v(" "),s("p",[t._v("再修改cluster.yml")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("- address: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.0")]),t._v(".20.6\n  port: "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"22"')]),t._v("\n  internal_address: "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n  role:\n  - worker\n  hostname_override: "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n  user: rke\n  docker_socket: /var/run/docker.sock\n  ssh_key: "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n  ssh_key_path: ~/.ssh/id_rsa\n  ssh_cert: "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n  ssh_cert_path: "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n  labels: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  taints: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n\n")])])]),s("p",[t._v("rke up --update-only")]),t._v(" "),s("h3",{attrs:{id:"添加-删除etcd节点"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#添加-删除etcd节点"}},[t._v("#")]),t._v(" 添加/删除etcd节点")]),t._v(" "),s("p",[t._v("再修改cluster.yml")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[t._v("- address: "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("10.0")]),t._v(".8.13\n  port: "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('"22"')]),t._v("\n  internal_address: "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n  role:\n  - etcd\n  hostname_override: "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n  user: rke\n  docker_socket: /var/run/docker.sock\n  ssh_key: "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n  ssh_key_path: ~/.ssh/id_rsa\n  ssh_cert: "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n  ssh_cert_path: "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v('""')]),t._v("\n  labels: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  taints: "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),t._v("\n")])])]),s("p",[t._v("rke up --update-only")]),t._v(" "),s("p",[t._v("kubectl get nodes")]),t._v(" "),s("h2",{attrs:{id:"部署nginx"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#部署nginx"}},[t._v("#")]),t._v(" 部署nginx")]),t._v(" "),s("p",[t._v("vim nginx.yml")]),t._v(" "),s("p",[t._v("vim nginx-service.yml")]),t._v(" "),s("h2",{attrs:{id:"部署nginx-ingress"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#部署nginx-ingress"}},[t._v("#")]),t._v(" 部署nginx-ingress")]),t._v(" "),s("div",{staticClass:"language-bash extra-class"},[s("pre",{pre:!0,attrs:{class:"language-bash"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("wget")]),t._v(" https://raw.githubusercontent.com/kubernetes/ingress-nginx/controller-v1.1.1/deploy/static/provider/baremetal/deploy.yaml\n\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" pull liangjw/kube-webhook-certgen:v1.1.1\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" pull liangjw/ingress-nginx-controller:v1.1.1\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("docker")]),t._v(" images\n")])])]),s("p",[t._v("修改 deploy.yaml")]),t._v(" "),s("p",[t._v("vim deploy.yaml")]),t._v(" "),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("type")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" NodePort\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ipFamilyPolicy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" SingleStack\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ipFamilies")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" IPv4\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ports")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" http\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("80")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("protocol")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" TCP\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("targetPort")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" http\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("appProtocol")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" http\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nodePort")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("30080")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("port")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("443")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("protocol")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" TCP\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("targetPort")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("appProtocol")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" https\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("nodePort")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("30443")]),t._v("\n  "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("selector")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app.kubernetes.io/name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ingress"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("nginx\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app.kubernetes.io/instance")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ingress"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("nginx\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("app.kubernetes.io/component")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" controller\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("---")]),t._v("\n\n")])])]),s("div",{staticClass:"language-yaml extra-class"},[s("pre",{pre:!0,attrs:{class:"language-yaml"}},[s("code",[s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("dnsPolicy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ClusterFirst\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" controller\n          "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# image: k8s.gcr.io/kube-webhook-certgen:v1.1.1@sha256:0bc88eb15f9e7f84e8e56c14fa5735aaa488b840983f87bd79b1054190e660de")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" docker.io/liangjw/ingress"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("nginx"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("controller"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("v1.1.1\n          "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("imagePullPolicy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" IfNotPresent\n          "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("lifecycle")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n            "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("preStop")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n              "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("exec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n                "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("command")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n                  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" /wait"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("shutdown\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" create\n          "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# image: k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" docker.io/liangjw/kube"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("webhook"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("certgen"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("v1.1.1\n          "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("imagePullPolicy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" IfNotPresent\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("...")]),t._v("\n    "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("spec")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("containers")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n        "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" patch\n          "),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# image: k8s.gcr.io/ingress-nginx/kube-webhook-certgen:v1.1.1@sha256:64d8c73dca984af206adf9d6d7e46aa550362b1d7a01f3a0a91b20cc67868660")]),t._v("\n          "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" docker.io/liangjw/kube"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("webhook"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("certgen"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("v1.1.1\n          "),s("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("imagePullPolicy")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" IfNotPresent\n")])])]),s("p",[t._v("kubectl apply -f deploy.yaml")])])}),[],!1,null,null,null);s.default=n.exports}}]);