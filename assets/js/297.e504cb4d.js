(window.webpackJsonp=window.webpackJsonp||[]).push([[297],{609:function(t,s,a){"use strict";a.r(s);var n=a(14),e=Object(n.a)({},(function(){var t=this,s=t._self._c;return s("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[s("h1",{attrs:{id:"inotifywait"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#inotifywait"}},[t._v("#")]),t._v(" inotifywait")]),t._v(" "),s("p",[t._v("异步文件系统监控机制")]),t._v(" "),s("h2",{attrs:{id:"补充说明"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#补充说明"}},[t._v("#")]),t._v(" 补充说明")]),t._v(" "),s("p",[s("strong",[t._v("Inotify")]),t._v(" 一种强大的、细粒度的、异步文件系统监控机制，它满足各种各样的文件监控需要，可以监控文件系统的访问属性、读写属性、权限属性、删除创建、移动等操作，也就是可以监控文件发生的一切变化。。")]),t._v(" "),s("p",[s("strong",[t._v("inotify-tools")]),t._v(" 是一个C库和一组命令行的工作提供Linux下inotify的简单接口。inotify-tools安装后会得到"),s("code",[t._v("inotifywait")]),t._v("和"),s("code",[t._v("inotifywatch")]),t._v("这两条命令：")]),t._v(" "),s("ul",[s("li",[s("strong",[t._v("inotifywait命令")]),t._v(" 可以用来收集有关文件访问信息，Linux发行版一般没有包括这个命令，需要安装inotify-tools，这个命令还需要将inotify支持编译入Linux内核，好在大多数Linux发行版都在内核中启用了inotify。")]),t._v(" "),s("li",[s("strong",[t._v("inotifywatch命令")]),t._v(" 用于收集关于被监视的文件系统的统计数据，包括每个 inotify 事件发生多少次。")])]),t._v(" "),s("p",[t._v("开始之前需要检测系统内核是否支持inotify：")]),t._v(" "),s("p",[t._v("使用"),s("code",[t._v("uname -r")]),t._v("命令检查Linux内核，如果低于2.6.13，就需要重新编译内核加入inotify的支持。")]),t._v(" "),s("p",[t._v("使用"),s("code",[t._v("ll /proc/sys/fs/inotify")]),t._v("命令，是否有以下三条信息输出，如果没有表示不支持。")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("ll /proc/sys/fs/inotify\ntotal "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v("\n-rw-r--r-- "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" root root "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" Jan  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("15")]),t._v(":41 max_queued_events\n-rw-r--r-- "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" root root "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" Jan  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("15")]),t._v(":41 max_user_instances\n-rw-r--r-- "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" root root "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),t._v(" Jan  "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("15")]),t._v(":41 max_user_watches\n")])])]),s("h3",{attrs:{id:"安装inotify-tools"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#安装inotify-tools"}},[t._v("#")]),t._v(" 安装inotify-tools")]),t._v(" "),s("ul",[s("li",[t._v("inotify-tools项目地址：https://github.com/rvoicilas/inotify-tools")]),t._v(" "),s("li",[t._v("inotify-tools下载地址：http://github.com/downloads/rvoicilas/inotify-tools/inotify-tools-3.14.tar.gz")])]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#CentOS release 5.8/64位：")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("tar")]),t._v(" zxvf inotify-tools-3.14.tar.gz\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("cd")]),t._v(" inotify-tools-3.14\n./configure\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("make")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("install")]),t._v("\n")])])]),s("p",[t._v("其他Linux发行版安装方法可以参见：https://github.com/rvoicilas/inotify-tools/wiki#wiki-getting")]),t._v(" "),s("h3",{attrs:{id:"inotify相关参数"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#inotify相关参数"}},[t._v("#")]),t._v(" inotify相关参数")]),t._v(" "),s("p",[t._v("inotify定义了下列的接口参数，可以用来限制inotify消耗kernel memory的大小。由于这些参数都是内存参数，因此，可以根据应用需求，实时的调节其大小：")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("/proc/sys/fs/inotify/max_queued_evnets")]),t._v("表示调用inotify_init时分配给inotify instance中可排队的event的数目的最大值，超出这个值的事件被丢弃，但会触发IN_Q_OVERFLOW事件。")]),t._v(" "),s("li",[s("code",[t._v("/proc/sys/fs/inotify/max_user_instances")]),t._v("表示每一个real user id可创建的inotify instatnces的数量上限。")]),t._v(" "),s("li",[s("code",[t._v("/proc/sys/fs/inotify/max_user_watches")]),t._v("表示每个inotify instatnces可监控的最大目录数量。如果监控的文件数目巨大，需要根据情况，适当增加此值的大小。")])]),t._v(" "),s("p",[t._v("根据以上在32位或者64位系统都可以执行：")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("104857600")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">")]),t._v(" /proc/sys/fs/inotify/max_user_watches\n"),s("span",{pre:!0,attrs:{class:"token builtin class-name"}},[t._v("echo")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'echo 104857600 > /proc/sys/fs/inotify/max_user_watches'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">>")]),t._v(" /etc/rc.local\n")])])]),s("p",[t._v("如果遇到以下错误：")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v("inotifywait: error "),s("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("while")]),t._v(" loading shared libraries: libinotifytools.so.0: cannot "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("open")]),t._v(" shared object file: No such "),s("span",{pre:!0,attrs:{class:"token function"}},[t._v("file")]),t._v(" or directory \n")])])]),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[t._v(" **解决方法：** \n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("32")]),t._v("位系统：ln "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-s")]),t._v(" /usr/local/lib/libinotifytools.so.0 /usr/lib/libinotifytools.so.0\n"),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("64")]),t._v("位系统：ln "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-s")]),t._v(" /usr/local/lib/libinotifytools.so.0 /usr/lib64/libinotifytools.so.0\n")])])]),s("h3",{attrs:{id:"inotifywait命令使用"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#inotifywait命令使用"}},[t._v("#")]),t._v(" inotifywait命令使用")]),t._v(" "),s("div",{staticClass:"language-shell extra-class"},[s("pre",{pre:!0,attrs:{class:"language-shell"}},[s("code",[s("span",{pre:!0,attrs:{class:"token shebang important"}},[t._v("#!/bin/bash")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[t._v("#filename watchdir.sh")]),t._v("\n"),s("span",{pre:!0,attrs:{class:"token assign-left variable"}},[t._v("path")]),s("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$1")]),t._v("\n/usr/local/bin/inotifywait "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-mrq")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--timefmt")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%d/%m/%y/%H:%M'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--format")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[t._v("'%T %w %f'")]),t._v(" "),s("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-e")]),t._v(" modify,delete,create,attrib "),s("span",{pre:!0,attrs:{class:"token variable"}},[t._v("$path")]),t._v("\n\n执行输出：\n./watchdir.sh /data/wsdata/tools/\n04/01/13/16:34 /data/wsdata/tools/ .j.jsp.swp\n04/01/13/16:34 /data/wsdata/tools/ .j.jsp.swx\n04/01/13/16:34 /data/wsdata/tools/ .j.jsp.swx\n04/01/13/16:34 /data/wsdata/tools/ .j.jsp.swp\n04/01/13/16:34 /data/wsdata/tools/ .j.jsp.swp\n04/01/13/16:34 /data/wsdata/tools/ .j.jsp.swp\n04/01/13/16:34 /data/wsdata/tools/ .j.jsp.swp\n04/01/13/16:34 /data/wsdata/tools/ .j.jsp.swp\n04/01/13/16:35 /data/wsdata/tools/ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4913")]),t._v("\n04/01/13/16:35 /data/wsdata/tools/ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4913")]),t._v("\n04/01/13/16:35 /data/wsdata/tools/ "),s("span",{pre:!0,attrs:{class:"token number"}},[t._v("4913")]),t._v("\n04/01/13/16:35 /data/wsdata/tools/ j.jsp\n04/01/13/16:35 /data/wsdata/tools/ j.jsp\n04/01/13/16:35 /data/wsdata/tools/ j.jsp\n04/01/13/16:35 /data/wsdata/tools/ j.jsp~\n04/01/13/16:35 /data/wsdata/tools/ .j.jsp.swp\n")])])]),s("h3",{attrs:{id:"inotifywait命令参数"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#inotifywait命令参数"}},[t._v("#")]),t._v(" inotifywait命令参数")]),t._v(" "),s("ul",[s("li",[s("code",[t._v("-m")]),t._v("是要持续监视变化。")]),t._v(" "),s("li",[s("code",[t._v("-r")]),t._v("使用递归形式监视目录。")]),t._v(" "),s("li",[s("code",[t._v("-q")]),t._v("减少冗余信息，只打印出需要的信息。")]),t._v(" "),s("li",[s("code",[t._v("-e")]),t._v("指定要监视的事件列表。")]),t._v(" "),s("li",[s("code",[t._v("--timefmt")]),t._v("是指定时间的输出格式。")]),t._v(" "),s("li",[s("code",[t._v("--format")]),t._v("指定文件变化的详细信息。")])]),t._v(" "),s("h3",{attrs:{id:"可监听的事件"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#可监听的事件"}},[t._v("#")]),t._v(" 可监听的事件")]),t._v(" "),s("table",[s("thead",[s("tr",[s("th",[t._v("事件")]),t._v(" "),s("th",[t._v("描述")])])]),t._v(" "),s("tbody",[s("tr",[s("td",[t._v("access")]),t._v(" "),s("td",[s("strong",[t._v("访问")]),t._v(" ，读取文件。")])]),t._v(" "),s("tr",[s("td",[t._v("modify")]),t._v(" "),s("td",[s("strong",[t._v("修改")]),t._v(" ，文件内容被修改。")])]),t._v(" "),s("tr",[s("td",[t._v("attrib")]),t._v(" "),s("td",[s("strong",[t._v("属性")]),t._v(" ，文件元数据被修改。")])]),t._v(" "),s("tr",[s("td",[t._v("move")]),t._v(" "),s("td",[s("strong",[t._v("移动")]),t._v(" ，对文件进行移动操作。")])]),t._v(" "),s("tr",[s("td",[t._v("create")]),t._v(" "),s("td",[s("strong",[t._v("创建")]),t._v(" ，生成新文件")])]),t._v(" "),s("tr",[s("td",[t._v("open")]),t._v(" "),s("td",[s("strong",[t._v("打开")]),t._v(" ，对文件进行打开操作。")])]),t._v(" "),s("tr",[s("td",[t._v("close")]),t._v(" "),s("td",[s("strong",[t._v("关闭")]),t._v(" ，对文件进行关闭操作。")])]),t._v(" "),s("tr",[s("td",[t._v("delete")]),t._v(" "),s("td",[s("strong",[t._v("删除")]),t._v(" ，文件被删除。")])])])])])}),[],!1,null,null,null);s.default=e.exports}}]);